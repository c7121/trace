# C4 Diagrams (Mermaid)

## System Context
```mermaid
flowchart TB
    users["Users (Analysts / Researchers / Ops)"]:::person
    ops["Platform Ops"]:::person
    idp["IdP (Cognito/SSO)"]:::ext
    trace["Trace Platform"]:::system
    rpc["RPC Providers"]:::ext
    obs["Observability - CloudWatch/CloudTrail"]:::ext
    webhooks["External Webhooks"]:::ext

    users -->|query, configure jobs, alerts| trace
    trace -->|authn/authz| idp
    trace -->|logs/metrics/audit| obs
    ops -->|observe/manage| obs
    trace -->|read chain data| rpc
    trace -->|deliver alerts| webhooks

    classDef person fill:#f6d6ff,stroke:#6f3fb3,color:#000;
    classDef system fill:#d6f6ff,stroke:#1f6fa3,color:#000;
    classDef ext fill:#eee,stroke:#666,color:#000;
```

## Container View
```mermaid
flowchart LR
    subgraph Trace["Trace Platform (VPC)"]
        subgraph Orchestration["Orchestration"]
            api["Gateway (API/CLI)"]:::container
            dispatcher["Dispatcher"]:::container
            sqs["SQS Queues"]:::infra
        end
        subgraph Compute["Workers"]
            workers["Workers (ECS Fargate)"]:::container
        end
        subgraph Storage["Storage"]
            postgres["Postgres (hot + state)"]:::database
            s3["S3 (Parquet cold)"]:::database
        end
        subgraph Query["Query"]
            duckdb["DuckDB"]:::container
        end
        subgraph Platform["Platform Services"]
            platformAuth["Auth/Policy"]:::infra
            platformSec["Secrets Manager"]:::infra
            platformObs["CloudWatch/CloudTrail"]:::infra
        end
    end

    subgraph Serverless["Serverless"]
        eventbridge["EventBridge"]:::infra
        lambda["Lambda Sources"]:::container
        apigw["API Gateway"]:::infra
    end

    users["Users"]:::person
    ops["Platform Ops"]:::person
    idp["IdP (Cognito/SSO)"]:::ext
    rpc["RPC Providers"]:::ext
    webhooks["External Webhooks"]:::ext

    users -->|access| api
    ops -->|observe| platformObs
    api -->|authn| idp
    api -->|request jobs, queries| dispatcher
    api -->|queries| duckdb
    
    eventbridge -->|cron| lambda
    apigw -->|webhook| lambda
    lambda -->|emit event| dispatcher
    
    dispatcher -->|create tasks| postgres
    dispatcher -->|enqueue| sqs
    sqs -->|deliver task| workers
    
    workers -->|fetch task, update status| postgres
    workers -->|write hot data| postgres
    workers -->|write cold data| s3
    workers -->|fetch secrets| platformSec
    workers -->|fetch chain data| rpc
    workers -->|deliver alerts| webhooks
    workers -->|emit telemetry| platformObs
    workers -->|emit upstream event| dispatcher
    
    duckdb -->|federated query| postgres
    duckdb -->|federated query| s3

    classDef person fill:#f6d6ff,stroke:#6f3fb3,color:#000;
    classDef container fill:#d6ffe7,stroke:#1f9a6f,color:#000;
    classDef database fill:#fff6d6,stroke:#c58b00,color:#000;
    classDef infra fill:#e8e8ff,stroke:#6666aa,color:#000;
    classDef ext fill:#eee,stroke:#666,color:#000;
```

## Component View: Orchestration
```mermaid
flowchart LR
    subgraph Sources["Lambda Sources"]
        cronSrc["Cron Source"]:::component
        webhookSrc["Webhook Source"]:::component
    end

    subgraph Dispatch["Dispatcher"]
        taskCreate["Task Creator"]:::component
        eventRouter["Upstream Event Router"]:::component
        reaper["Dead Task Reaper"]:::component
        sourceMon["Source Monitor"]:::component
        manualApi["Manual Trigger API"]:::component
    end

    eventbridge["EventBridge"]:::infra
    apigw["API Gateway"]:::infra
    sqs["SQS Queues"]:::infra
    postgres["Postgres"]:::database
    workers["ECS Workers"]:::component

    eventbridge -->|invoke| cronSrc
    apigw -->|invoke| webhookSrc
    
    cronSrc -->|emit event| eventRouter
    webhookSrc -->|emit event| eventRouter
    manualApi -->|create task| taskCreate
    
    workers -.->|upstream event| eventRouter
    eventRouter -->|find dependents| postgres
    eventRouter -->|create tasks| taskCreate
    
    taskCreate -->|create task| postgres
    taskCreate -->|enqueue| sqs
    reaper -->|check heartbeats| postgres
    reaper -->|mark failed| postgres
    sourceMon -->|check health| postgres

    classDef component fill:#d6ffe7,stroke:#1f9a6f,color:#000;
    classDef infra fill:#e8e8ff,stroke:#6666aa,color:#000;
    classDef database fill:#fff6d6,stroke:#c58b00,color:#000;
```

## Component View: Workers
```mermaid
flowchart LR
    subgraph Worker["Worker Container"]
        wrapper["Worker Wrapper"]:::component
        operator["Operator (job code)"]:::component
    end

    sqs["SQS"]:::infra
    postgres["Postgres"]:::database
    s3["S3"]:::database
    secrets["Secrets Manager"]:::infra
    rpc["RPC Providers"]:::ext

    sqs -->|task_id| wrapper
    wrapper -->|fetch task| postgres
    wrapper -->|fetch secrets| secrets
    wrapper -->|inject config + secrets| operator
    wrapper -->|heartbeat| postgres
    
    operator -->|read/write hot| postgres
    operator -->|write cold| s3
    operator -.->|platform jobs only| rpc
    
    wrapper -->|update status| postgres
    wrapper -->|ack| sqs

    classDef component fill:#d6ffe7,stroke:#1f9a6f,color:#000;
    classDef infra fill:#e8e8ff,stroke:#6666aa,color:#000;
    classDef database fill:#fff6d6,stroke:#c58b00,color:#000;
    classDef ext fill:#eee,stroke:#666,color:#000;
```

## Component View: Query Service
```mermaid
flowchart LR
    api["Gateway"]:::container
    duckdb["DuckDB"]:::component
    postgres["Postgres (hot)"]:::database
    s3["S3 Parquet (cold)"]:::database

    api -->|SQL query| duckdb
    duckdb -->|recent data| postgres
    duckdb -->|historical data| s3

    classDef component fill:#d6ffe7,stroke:#1f9a6f,color:#000;
    classDef container fill:#d6ffe7,stroke:#1f9a6f,color:#000;
    classDef database fill:#fff6d6,stroke:#c58b00,color:#000;
```

## Operator Examples

Operators are job implementations. See [Operator Catalog](../operators/README.md).

| Operator | Trigger | Execution |
|----------|---------|----------|
| `block_follower` | `none` | â€” |
| `cryo_ingest` | `upstream` | PerPartition |
| `parquet_compact` | `upstream` | Bulk |
| `alert_evaluate_*` | `upstream` | PerUpdate |
| `alert_deliver` | `upstream` | PerUpdate |
| `duckdb_query` | `upstream` | Bulk |
