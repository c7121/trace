# C4 Architecture Diagrams

This page is the canonical home for Trace's C4 diagrams.

- **L1 (System Context)** shows Trace and its external dependencies.
- **L2 (Container View)** shows the major deployable services and data stores inside Trace.

Lower-level component details live in each container document under `docs/architecture/containers/`.

## C4 L1: System Context

```mermaid
flowchart TB
    users["Users"]:::person
    ops["Platform Ops"]:::person
    idp["IdP"]:::ext
    trace["Trace Platform"]:::system
    rpc["RPC Providers"]:::ext
    obs["Observability"]:::ext
    webhooks["External Webhooks"]:::ext

    users --> trace
    trace --> idp
    trace --> obs
    ops --> obs
    trace --> rpc
    trace --> webhooks

    classDef person fill:#f6d6ff,stroke:#6f3fb3,color:#000;
    classDef system fill:#d6f6ff,stroke:#1f6fa3,color:#000;
    classDef ext fill:#eee,stroke:#666,color:#000;
```


## C4 L2: Container View

```mermaid
flowchart TB
    users["Users"]:::person
    ops["Platform Ops"]:::person
    rpc["RPC Providers"]:::ext
    webhooks["External Webhooks"]:::ext

    subgraph Trace["Trace Platform"]
        gateway["Gateway"]:::container
        dispatcher["Dispatcher"]:::container
        query["Query Service"]:::container
        broker["Credential Broker"]:::container
        rpcgw["RPC Egress Gateway"]:::container
        delivery["Delivery Service"]:::container
        sinks["Dataset Sinks"]:::container

        platform_workers["Platform Workers"]:::container
        udf_workers["UDF Workers"]:::container

        pg_state["Postgres: State"]:::database
        pg_data["Postgres: Data"]:::database
        s3["S3 Parquet"]:::database

        task_sqs["SQS Task Queues"]:::infra
        buffer_sqs["SQS Dataset Buffers"]:::infra
        bus["EventBridge"]:::infra
    end

    users --> gateway
    ops --> dispatcher

    gateway --> dispatcher
    gateway --> query

    dispatcher --> pg_state
    dispatcher --> bus
    dispatcher --> task_sqs
    dispatcher --> buffer_sqs

    task_sqs --> platform_workers
    task_sqs --> udf_workers

    platform_workers --> dispatcher
    udf_workers --> dispatcher

    platform_workers --> pg_data
    platform_workers --> s3
    platform_workers --> buffer_sqs
    platform_workers --> rpcgw

    udf_workers --> query
    udf_workers --> broker
    udf_workers --> s3
    udf_workers --> buffer_sqs

    buffer_sqs --> sinks
    sinks --> pg_data

    query --> pg_data
    query --> s3

    rpcgw --> rpc
    delivery --> pg_data
    delivery --> webhooks

    classDef person fill:#f6d6ff,stroke:#6f3fb3,color:#000;
    classDef container fill:#d6ffe7,stroke:#1f9a6f,color:#000;
    classDef database fill:#fff6d6,stroke:#c58b00,color:#000;
    classDef infra fill:#e8e8ff,stroke:#6666aa,color:#000;
    classDef ext fill:#eee,stroke:#666,color:#000;
```


## Notes

- **Workers have no direct internet egress.** Any external calls happen through dedicated egress services (Delivery Service, RPC Egress Gateway). See ADR 0002.
- **UDF workers do not connect to Postgres directly.** They read via Query Service and obtain scoped S3 credentials via Credential Broker.
- The Dispatcher is the orchestration control plane; Postgres (state) is the durable source of truth; SQS is a wake-up mechanism (see `task_lifecycle.md`).
